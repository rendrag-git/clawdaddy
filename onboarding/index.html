<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClawDaddy Onboarding</title>
    <meta name="description" content="Complete your ClawDaddy setup and get your OpenClaw webchat URL." />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              lobster: "#E63946",
            },
            boxShadow: {
              glow: "0 0 0 1px rgba(230,57,70,0.25), 0 12px 34px rgba(230,57,70,0.2)",
            },
          },
        },
      };
    </script>
    <style>
      :root {
        --bg: #090b10;
        --bg-soft: #111318;
        --panel: rgba(24, 24, 27, 0.75);
        --panel-border: rgba(63, 63, 70, 0.8);
        --text: #f4f4f5;
        --text-muted: #a1a1aa;
        --input-bg: rgba(24, 24, 27, 0.9);
        --accent: #E63946;
        --accent-2: #ef4444;
        --success: #4ade80;
        --pending: #71717a;
        --shadow: 0 0 0 1px rgba(230,57,70,0.25), 0 12px 34px rgba(230,57,70,0.2);
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
      }

      body {
        min-height: 100vh;
        font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at 10% 0%, rgba(230, 57, 70, 0.2), transparent 34%),
          radial-gradient(circle at 90% 20%, rgba(230, 57, 70, 0.12), transparent 30%),
          var(--bg);
      }

      .page {
        width: 100%;
        min-height: 100vh;
        padding: 2rem 1rem;
        display: grid;
        place-items: center;
      }

      .shell {
        width: min(780px, 100%);
      }

      .brand {
        margin: 0 0 1rem;
        text-align: center;
        font-size: clamp(1.5rem, 4vw, 1.95rem);
        font-weight: 800;
        letter-spacing: -0.02em;
      }

      .tagline {
        text-align: center;
        margin: 0 0 2rem;
        color: var(--text-muted);
      }

      .panel {
        background: rgba(24, 24, 27, 0.75);
        border: 1px solid var(--panel-border);
        border-radius: 20px;
        padding: clamp(1.2rem, 2.2vw, 2rem);
        box-shadow: var(--shadow);
      }

      .session-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        border-radius: 999px;
        border: 1px solid rgba(63, 63, 70, 0.6);
        background: rgba(24, 24, 27, 0.85);
        padding: 0.4rem 0.7rem;
        color: #a1a1aa;
        font-size: 0.82rem;
        letter-spacing: 0.01em;
      }

      .title {
        margin: 0.9rem 0 0.5rem;
        font-size: clamp(1.35rem, 2.8vw, 2rem);
        line-height: 1.2;
      }

      .copy {
        margin: 0;
        color: var(--text-muted);
        line-height: 1.6;
      }

      .form {
        margin-top: 1.4rem;
        display: grid;
        gap: 1rem;
      }

      .field {
        display: grid;
        gap: 0.45rem;
      }

      .label {
        font-size: 0.9rem;
        color: #d4d4d8;
        font-weight: 600;
      }

      .input {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(63, 63, 70, 0.8);
        background: var(--input-bg);
        color: var(--text);
        font-size: 1rem;
        padding: 0.78rem 0.85rem;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .input:focus {
        border-color: rgba(230, 57, 70, 0.85);
        box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.2);
      }

      .button {
        border: 0;
        border-radius: 12px;
        background: #E63946;
        color: #fff;
        font-size: 1rem;
        font-weight: 800;
        letter-spacing: 0.01em;
        padding: 0.88rem 1rem;
        cursor: pointer;
        transition: transform 0.15s ease, filter 0.15s ease;
      }

      .button:hover {
        transform: translateY(-1px);
        filter: brightness(1.05);
      }

      .button:disabled {
        cursor: not-allowed;
        opacity: 0.65;
        transform: none;
      }

      .error {
        margin-top: 0.95rem;
        color: #fca5a5;
        min-height: 1.2rem;
        font-size: 0.9rem;
      }

      .hidden {
        display: none;
      }

      .footer {
        margin-top: 1.1rem;
        text-align: center;
        color: var(--text-muted);
        font-size: 0.88rem;
      }

      .footer a {
        color: #E63946;
      }

      /* Step transitions */
      .step-container {
        display: none;
      }

      .step-container.active {
        display: block;
        animation: fadeIn 0.4s ease;
      }

      /* Username availability indicator */
      .username-check {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.85rem;
        min-height: 1.4rem;
        margin-top: 0.25rem;
      }

      .username-check.available {
        color: var(--success);
      }

      .username-check.taken {
        color: #fca5a5;
      }

      .username-check .suggestion-link {
        color: #E63946;
        text-decoration: underline;
        cursor: pointer;
      }

      .subdomain-preview {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 0.2rem;
        font-family: monospace;
      }

      /* Provisioning chip */
      .provision-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.85rem;
        border-radius: 999px;
        font-size: 0.82rem;
        background: rgba(24, 24, 27, 0.85);
        border: 1px solid rgba(63, 63, 70, 0.6);
        margin-bottom: 1rem;
      }

      .provision-chip .pulse-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--accent);
        animation: pulse 1.6s ease-in-out infinite;
      }

      .provision-chip.ready .pulse-dot {
        background: var(--success);
        animation: none;
      }

      /* Quiz progress bar */
      .quiz-progress {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 2px;
        margin-bottom: 1.2rem;
        overflow: hidden;
      }

      .quiz-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #E63946, #ef4444);
        border-radius: 2px;
        transition: width 0.4s ease;
      }

      /* Quiz question counter */
      .quiz-counter {
        font-size: 0.82rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
      }

      /* Quiz question area */
      .quiz-question-area {
        position: relative;
        overflow: hidden;
        min-height: 420px;
      }

      /* Quiz question transitions */
      .quiz-slide {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        width: 100%;
        transition: transform 0.3s ease, opacity 0.3s ease;
      }

      .quiz-slide.slide-out-left {
        transform: translateX(-30px);
        opacity: 0;
        pointer-events: none;
      }

      .quiz-slide.slide-in-right {
        transform: translateX(30px);
        opacity: 0;
      }

      .quiz-slide.slide-out-right {
        transform: translateX(30px);
        opacity: 0;
        pointer-events: none;
      }

      /* Quiz prompt */
      .quiz-prompt {
        font-size: clamp(1.05rem, 2.2vw, 1.25rem);
        font-weight: 600;
        line-height: 1.4;
        margin: 0 0 1.2rem;
      }

      .quiz-helper {
        font-size: 0.88rem;
        color: var(--text-muted);
        margin: -0.6rem 0 1rem;
      }

      /* Option buttons (single select) */
      .quiz-options {
        display: grid;
        gap: 0.6rem;
      }

      .quiz-option {
        display: flex;
        align-items: center;
        text-align: left;
        width: 100%;
        min-height: 52px;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 1px solid rgba(63, 63, 70, 0.6);
        background: var(--input-bg);
        color: var(--text);
        font-size: 0.95rem;
        line-height: 1.4;
        cursor: pointer;
        transition: border-color 0.2s, background 0.2s, transform 0.15s;
      }

      .quiz-option:hover {
        border-color: rgba(230, 57, 70, 0.5);
        background: rgba(230, 57, 70, 0.08);
        transform: translateY(-1px);
      }

      .quiz-option.selected {
        border-color: var(--accent);
        background: rgba(230, 57, 70, 0.15);
        box-shadow: 0 0 0 2px rgba(230, 57, 70, 0.25);
      }

      /* Multi-select (checkbox style) */
      .quiz-option.multi {
        position: relative;
        padding-left: 2.8rem;
      }

      .quiz-option.multi::before {
        content: '';
        position: absolute;
        left: 0.85rem;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        border-radius: 6px;
        border: 2px solid rgba(63, 63, 70, 0.6);
        background: transparent;
        transition: all 0.2s;
      }

      .quiz-option.multi.selected::before {
        background: var(--accent);
        border-color: var(--accent);
      }

      .quiz-option.multi.selected::after {
        content: '\2713';
        position: absolute;
        left: 0.95rem;
        top: 50%;
        transform: translateY(-50%);
        color: #fff;
        font-size: 0.85rem;
        font-weight: 700;
      }

      /* Add context toggle */
      .add-context-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.82rem;
        color: var(--text-muted);
        cursor: pointer;
        margin-top: 0.8rem;
        padding: 0.3rem 0;
        border: none;
        background: none;
      }

      .add-context-toggle:hover {
        color: var(--accent);
      }

      .context-input {
        margin-top: 0.5rem;
      }

      .context-input textarea {
        width: 100%;
        min-height: 60px;
        border-radius: 10px;
        border: 1px solid rgba(63, 63, 70, 0.6);
        background: var(--input-bg);
        color: var(--text);
        font-size: 0.88rem;
        padding: 0.6rem;
        resize: vertical;
        outline: none;
        font-family: inherit;
      }

      /* Quiz navigation */
      .quiz-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1.2rem;
        gap: 0.8rem;
      }

      .quiz-back {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        border: none;
        background: none;
        color: var(--text-muted);
        font-size: 0.9rem;
        cursor: pointer;
        padding: 0.5rem 0.8rem;
        border-radius: 8px;
      }

      .quiz-back:hover {
        color: var(--text);
        background: rgba(255, 255, 255, 0.05);
      }

      .quiz-continue {
        border: 0;
        border-radius: 12px;
        background: #E63946;
        color: #fff;
        font-size: 0.95rem;
        font-weight: 700;
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        min-height: 44px;
        transition: transform 0.15s, filter 0.15s;
      }

      .quiz-continue:hover {
        transform: translateY(-1px);
        filter: brightness(1.05);
      }

      .quiz-continue:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .skip-text {
        font-size: 0.8rem;
        color: var(--text-muted);
        text-align: center;
        margin-top: 0.5rem;
      }

      /* Section break */
      .section-break {
        text-align: center;
        padding: 2rem 0;
      }

      .section-break h3 {
        font-size: 1.3rem;
        margin: 0 0 0.8rem;
      }

      .section-break p {
        color: var(--text-muted);
        margin: 0 0 1.5rem;
        line-height: 1.5;
      }

      /* Success state */
      .success-state {
        text-align: center;
        padding: 1.5rem 0;
      }

      .success-check {
        font-size: 4rem;
        animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: block;
        margin-bottom: 1rem;
      }

      .success-title {
        font-size: clamp(1.5rem, 3vw, 2rem);
        font-weight: 800;
        background: linear-gradient(110deg, #E63946, #ef4444, #4ade80);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0 0 1rem;
      }

      .success-url {
        font-family: monospace;
        font-size: clamp(1rem, 2.5vw, 1.3rem);
        color: #E63946;
        margin: 0.8rem 0;
        word-break: break-all;
      }

      .copy-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.6rem 1.2rem;
        border-radius: 10px;
        border: 1px solid rgba(63, 63, 70, 0.6);
        background: rgba(24, 24, 27, 0.6);
        color: var(--text);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .copy-btn:hover {
        border-color: #E63946;
        background: rgba(230, 57, 70, 0.1);
      }

      .copy-btn.copied {
        border-color: var(--success);
        color: var(--success);
      }

      .redirect-text {
        color: var(--text-muted);
        font-size: 0.95rem;
        margin-top: 1.5rem;
      }

      .bookmark-text {
        color: var(--text-muted);
        font-size: 0.88rem;
        margin: 0.8rem 0;
      }

      /* Waiting/auth states */
      .waiting-state {
        text-align: center;
        padding: 2rem 0;
      }

      .waiting-state p {
        color: var(--text-muted);
        margin: 0.5rem 0;
      }

      .auth-status {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
        font-size: 0.95rem;
      }

      .auth-status.confirmed {
        color: var(--success);
      }

      /* Final textarea */
      .final-textarea {
        width: 100%;
        min-height: 120px;
        border-radius: 12px;
        border: 1px solid rgba(63, 63, 70, 0.6);
        background: var(--input-bg);
        color: var(--text);
        font-size: 1rem;
        padding: 0.85rem;
        resize: vertical;
        outline: none;
        font-family: inherit;
        line-height: 1.5;
      }

      .final-textarea:focus {
        border-color: rgba(230, 57, 70, 0.85);
        box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.2);
      }

      .final-textarea::placeholder {
        color: var(--text-muted);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes scaleIn {
        from {
          transform: scale(0);
        }
        to {
          transform: scale(1);
        }
      }

      @keyframes popIn {
        0% { transform: scale(0.5); opacity: 0; }
        80% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
      }

      .pop-in {
        animation: popIn 0.6s ease-out forwards;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.08);
          opacity: 0.84;
        }
      }

      @media (max-width: 640px) {
        .page {
          padding: 1rem 0.85rem;
        }
      }

      .profile-progress { text-align: center; padding: 2rem 0; }
      .profile-stages { display: flex; justify-content: center; gap: 1.5rem; margin: 1.5rem 0; }
      .profile-stage { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
      .profile-stage-dot {
        width: 12px; height: 12px; border-radius: 50%;
        background: rgba(161,161,170,0.3);
        transition: all 0.4s ease;
      }
      .profile-stage-dot.active {
        background: #E63946;
        box-shadow: 0 0 12px rgba(230,57,70,0.5);
        animation: stagePulse 1.8s ease-in-out infinite;
      }
      .profile-stage-dot.done { background: #4ade80; }
      .profile-stage-label { font-size: 0.75rem; color: #a1a1aa; white-space: nowrap; }
      .profile-stage-label.active { color: #f4f4f5; }
      .profile-stage-label.done { color: #4ade80; }
      .profile-message { font-size: 1rem; color: #d4d4d8; margin-top: 1rem; }

      @keyframes stagePulse {
        0%, 100% { box-shadow: 0 0 12px rgba(230,57,70,0.5); }
        50% { box-shadow: 0 0 24px rgba(230,57,70,0.8); }
      }

      .provider-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin: 1.2rem 0;
      }

      .provider-card {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.85rem;
        border-radius: 12px;
        border: 1px solid rgba(63,63,70,0.8);
        background: rgba(24,24,27,0.75);
        cursor: pointer;
        transition: border-color 0.2s, background 0.2s;
      }

      .provider-card:hover { border-color: rgba(113,113,122,0.8); }
      .provider-card.active { border-color: #E63946; background: rgba(230,57,70,0.08); }
      .provider-card.connected { border-color: #4ade80; }

      .provider-icon {
        width: 36px; height: 36px; border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        font-weight: 700; font-size: 0.85rem; color: #fff;
        flex-shrink: 0;
      }

      .provider-name { font-weight: 600; font-size: 0.9rem; }

      .provider-badge {
        margin-left: auto;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 999px;
        font-weight: 600;
      }
      .provider-badge.connected { background: rgba(74,222,128,0.15); color: #4ade80; }
      .provider-badge.disconnected { background: rgba(161,161,170,0.1); color: #71717a; }

      .provider-detail {
        padding: 1rem;
        border-radius: 12px;
        border: 1px solid rgba(63,63,70,0.6);
        background: rgba(24,24,27,0.6);
        margin-bottom: 0.75rem;
      }

      .provider-divider {
        display: flex; align-items: center; gap: 0.75rem;
        margin: 0.75rem 0; color: #71717a; font-size: 0.82rem;
      }
      .provider-divider::before, .provider-divider::after {
        content: ''; flex: 1; height: 1px; background: rgba(63,63,70,0.6);
      }

      @media (max-width: 480px) {
        .provider-grid { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <main class="page">
      <!-- Buffer / Welcome Screen -->
      <section id="welcome-screen" class="mx-auto max-w-xl px-4 py-16 text-center">
        <h1 class="text-3xl font-black text-white sm:text-4xl">Welcome to ClawDaddy</h1>
        <p class="mt-4 text-lg text-zinc-300">Thanks for subscribing! Let's set up your personal AI assistant.</p>
        <p class="mt-2 text-sm text-zinc-400">You'll take a quick personality quiz, connect your AI provider, and we'll spin up a dedicated assistant just for you.</p>
        <button id="start-setup-btn" class="mt-8 inline-flex min-h-[46px] items-center justify-center rounded-xl bg-lobster px-8 py-3 font-bold text-white shadow-glow transition hover:-translate-y-0.5 hover:bg-red-500">Start Setup</button>
      </section>

      <div id="wizard-content" style="display: none">
      <section class="shell">
        <h1 class="brand">ClawDaddy Onboarding</h1>
        <p class="tagline">Let's personalize your AI assistant.</p>

        <article class="panel" id="onboarding-panel">
          <span class="session-chip">Session: <strong id="session-preview">loading...</strong></span>

          <!-- Step 2: Personality Quiz -->
          <div id="step-2" class="step-container">
            <div id="provision-chip" class="provision-chip">
              <span class="pulse-dot"></span>
              <span id="provision-text">Setting up your server...</span>
            </div>

            <div class="quiz-progress">
              <div id="quiz-progress-fill" class="quiz-progress-fill" style="width: 0%"></div>
            </div>

            <div id="quiz-counter" class="quiz-counter"></div>

            <div id="quiz-question-area" class="quiz-question-area"></div>
          </div>

          <!-- Step 3: Connect Your AI -->
          <div id="step-3" class="step-container">
            <h2 class="title">Connect Your AI</h2>
            <div id="step-3-content"></div>
          </div>

          <!-- Step 4: You're All Set -->
          <div id="step-4" class="step-container">
            <div class="success-state"></div>
          </div>
        </article>

        <p class="footer">Need help? <a href="mailto:hello@clawdaddy.sh">hello@clawdaddy.sh</a></p>
      </section>
      </div>
    </main>

    <script>
      (function () {
        // ======== API Base URL ========
        // CloudFront serves the static site at clawdaddy.sh, but API lives on the EC2 control plane.
        // Use relative paths when served from the control plane, absolute URL when on CloudFront.
        const API_BASE = window.location.hostname === 'clawdaddy.sh' || window.location.hostname === 'www.clawdaddy.sh'
          ? 'https://api.clawdaddy.sh'
          : '';

        // ======== Session Validation ========
        const params = new URLSearchParams(window.location.search);
        const sessionId = (params.get('session_id') || '').trim();

        if (!sessionId) {
          window.location.replace('./error.html?reason=missing_session');
          return;
        }

        if (!/^cs_[a-zA-Z0-9_]+$/.test(sessionId)) {
          window.location.replace('./error.html?reason=invalid_session');
          return;
        }

        document.getElementById('session-preview').textContent = 'loading...';

        // ======== Init: Load customer data from API ========
        async function initOnboarding() {
          try {
            const response = await fetch(`${API_BASE}/api/onboarding`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
              body: JSON.stringify({ sessionId })
            });
            const payload = await readJson(response);

            if (!response.ok || !payload.ok) {
              if (response.status === 404) {
                state.initRetries = (state.initRetries || 0) + 1;
                if (state.initRetries >= 10) {
                  // ~30s of retries — bail with support message
                  document.getElementById('welcome-screen').querySelector('p').textContent =
                    'We couldn\'t find your account. Please contact hello@clawdaddy.sh for help.';
                  return;
                }
                document.getElementById('welcome-screen').querySelector('p').textContent =
                  'Setting up your account... This may take a moment after payment.';
                setTimeout(initOnboarding, 3000); // retry
                return;
              }
              throw new Error(payload.error || 'Failed to load onboarding data.');
            }

            state.username = payload.username;
            state.botName = payload.botName;
            state.serverStatus = payload.provisionStatus;
            state.serverReady = payload.provisionStatus === 'ready';

            // Update UI with customer info
            document.getElementById('session-preview').textContent = `${payload.username}`;

            // If server says we're past quiz step, don't restore localStorage
            if (payload.step && payload.step !== 'quiz') {
              clearQuizState();
              document.getElementById('welcome-screen').style.display = 'none';
              document.getElementById('wizard-content').style.display = '';
              if (payload.step === 'auth' || payload.step === 'profile') {
                showStep(3);
                startPolling();
                renderStep3();
              } else if (payload.step === 'complete') {
                showStep(4);
                renderSetupComplete();
              }
              return;
            }

            // Try restoring quiz state from localStorage
            state.quizRestored = restoreQuizState();
          } catch (error) {
            console.error('Init failed:', error);
          }
        }

        // ======== Buffer Page ========
        // Welcome screen "Start Setup" goes straight to quiz
        document.getElementById('start-setup-btn').addEventListener('click', async () => {
          document.getElementById('welcome-screen').style.display = 'none';
          document.getElementById('wizard-content').style.display = '';
          showStep(2); // Skip step 1, go straight to quiz
          startPolling();
          renderQuestion();
        });

        initOnboarding();

        // ======== Quiz Data ========
        const QUIZ_QUESTIONS = [
          {
            id: 'A1', section: 'A', type: 'single_select',
            prompt: 'Your brain is a browser with 37 tabs open. A surprise meeting starts in 10 minutes. What do you do?',
            options: [
              { id: 'A1a', label: 'Make a tiny checklist, pick the top 3 tabs, and close the rest like a hero.', weights: { organized: 0.9, proactive: 0.7, detailed: 0.4, serious: 0.2, practical: 0.4 } },
              { id: 'A1b', label: 'Improvise. The meeting can\'t hurt you if you pretend it\'s a podcast.', weights: { spontaneous: 0.9, casual: 0.6, playful: 0.4, big_picture: 0.5 } },
              { id: 'A1c', label: 'Message someone: "Give me the one thing I must know." Then roll in with confidence.', weights: { collaborative: 0.8, reactive: 0.5, big_picture: 0.6, casual: 0.4 } },
              { id: 'A1d', label: 'Open a doc and write a crisp 5-line brief (problem, goal, plan, risks, next step).', weights: { organized: 0.7, formal: 0.5, proactive: 0.6, detailed: 0.7, serious: 0.4, analytical: 0.3 } }
            ]
          },
          {
            id: 'A2', section: 'A', type: 'single_select',
            prompt: 'You buy a new gadget. There is no setup wizard. Your move?',
            options: [
              { id: 'A2a', label: 'Read the manual. Yes, cover-to-cover. Like a bedtime story.', weights: { organized: 0.6, detailed: 0.8, serious: 0.4, independent: 0.5, analytical: 0.4 } },
              { id: 'A2b', label: 'Press buttons until it works. If it sparks, that\'s feedback.', weights: { spontaneous: 0.8, playful: 0.4, independent: 0.6, big_picture: 0.4, exploratory: 0.4 } },
              { id: 'A2c', label: 'Search "best settings" and steal wisdom from the internet hive-mind.', weights: { proactive: 0.6, big_picture: 0.6, independent: 0.4, detailed: 0.3, practical: 0.3 } },
              { id: 'A2d', label: 'Ask a friend who\'s into this stuff and let them do the first run.', weights: { collaborative: 0.8, casual: 0.5, reactive: 0.4 } }
            ]
          },
          {
            id: 'A3', section: 'A', type: 'single_select',
            prompt: 'You\'re traveling. The plan says "Museum at 2." At 1:50 you see an alley that smells like incredible food. You…',
            options: [
              { id: 'A3a', label: 'Stick to the plan. The museum ticket is already in my calendar (and my soul).', weights: { organized: 0.8, proactive: 0.4, serious: 0.3 } },
              { id: 'A3b', label: 'Detour immediately. The best stories are never in the itinerary.', weights: { spontaneous: 0.9, playful: 0.5, big_picture: 0.4 } },
              { id: 'A3c', label: 'Do both: quick bite now, museum later. Time is a suggestion.', weights: { organized: 0.4, spontaneous: 0.5, proactive: 0.5, big_picture: 0.4 } },
              { id: 'A3d', label: 'Ask a local (or the assistant) which choice will make Future Me happiest.', weights: { collaborative: 0.6, big_picture: 0.6, proactive: 0.4 } }
            ]
          },
          {
            id: 'A4', section: 'A', type: 'single_select',
            prompt: 'Someone pings: "Quick question" at 4:59pm. You…',
            options: [
              { id: 'A4a', label: 'Answer now with context, steps, and a tiny screenshot if needed.', weights: { proactive: 0.7, detailed: 0.8, collaborative: 0.3, serious: 0.3 } },
              { id: 'A4b', label: 'Reply with a one-liner + suggest a time tomorrow if it\'s bigger than quick.', weights: { organized: 0.6, formal: 0.4, proactive: 0.5, big_picture: 0.5 } },
              { id: 'A4c', label: 'Send a friendly TL;DR and a meme. It\'s morale maintenance.', weights: { casual: 0.8, playful: 0.7, big_picture: 0.3 } },
              { id: 'A4d', label: 'Pretend I didn\'t see it. Boundaries are self-care.', weights: { reactive: 0.7, independent: 0.5, serious: 0.4 } }
            ]
          },
          {
            id: 'A5', section: 'A', type: 'single_select',
            prompt: 'Pick your assistant\'s vibe in a movie scene:',
            options: [
              { id: 'A5a', label: 'Polished concierge: crisp, calm, and always one step ahead.', weights: { formal: 0.8, organized: 0.5, proactive: 0.6, serious: 0.5, practical: 0.3 } },
              { id: 'A5b', label: 'Friendly co-pilot: warm, plainspoken, and low-drama.', weights: { casual: 0.7, collaborative: 0.6, serious: 0.2, proactive: 0.3 } },
              { id: 'A5c', label: 'Witty sidekick: helpful, fast, and occasionally unhinged (in a safe way).', weights: { playful: 0.8, casual: 0.6, proactive: 0.4, big_picture: 0.3, exploratory: 0.3 } },
              { id: 'A5d', label: 'Zen minimalist: fewer words, more results.', weights: { serious: 0.4, big_picture: 0.6, independent: 0.5, formal: 0.3 } }
            ]
          },
          {
            id: 'A6', section: 'A', type: 'single_select',
            prompt: 'If the assistant thinks you\'re about to do something suboptimal (but not dangerous), it should…',
            options: [
              { id: 'A6a', label: 'Gently push back with evidence and a better option.', weights: { proactive: 0.6, serious: 0.4, detailed: 0.5, independent: 0.3, challenging: 0.7, analytical: 0.3 } },
              { id: 'A6b', label: 'Ask 1-2 clarifying questions before suggesting anything.', weights: { collaborative: 0.7, detailed: 0.6, organized: 0.3, supportive: 0.4, empathetic: 0.3 } },
              { id: 'A6c', label: 'Show quick pros/cons, then let me decide immediately.', weights: { big_picture: 0.7, casual: 0.4, independent: 0.5, practical: 0.4 } },
              { id: 'A6d', label: 'Default to what I asked, unless I explicitly say "challenge me."', weights: { reactive: 0.6, casual: 0.3, independent: 0.4, supportive: 0.5 } }
            ]
          },
          {
            id: 'A7', section: 'A', type: 'single_select',
            prompt: 'You bring the assistant a half-baked idea. What should it do?',
            options: [
              { id: 'A7a', label: 'Poke holes in it. Show me where the logic breaks before I get attached.', weights: { challenging: 0.9, analytical: 0.7, proactive: 0.5 } },
              { id: 'A7b', label: 'Build on it. Add possibilities I haven\'t thought of yet.', weights: { exploratory: 0.8, supportive: 0.5, playful: 0.3 } },
              { id: 'A7c', label: 'Organize it. Turn the mess into a structured plan with clear next steps.', weights: { practical: 0.8, organized: 0.6, analytical: 0.3 } },
              { id: 'A7d', label: 'Get excited about it. Help me feel good enough to keep going.', weights: { supportive: 0.9, empathetic: 0.6, casual: 0.3 } }
            ]
          },
          {
            id: 'A8', section: 'A', type: 'single_select',
            prompt: 'When the assistant is working on something (research, planning, drafting), how should it update you?',
            options: [
              { id: 'A8a', label: 'Frequent check-ins. I like to steer the ship in real time.', weights: { collaborative: 0.6, detailed: 0.5, proactive: 0.4, supportive: 0.3, empathetic: 0.2 } },
              { id: 'A8b', label: 'Only at milestones: "Here\'s where I am, here\'s what\'s next."', weights: { organized: 0.6, big_picture: 0.6, serious: 0.2 } },
              { id: 'A8c', label: 'Only if blocked or if a decision is needed.', weights: { independent: 0.6, big_picture: 0.5, proactive: 0.3, analytical: 0.2 } },
              { id: 'A8d', label: 'No updates—just deliver the finished thing (with a quick recap).', weights: { independent: 0.8, organized: 0.4, serious: 0.3 } }
            ]
          },
          {
            id: 'A9', section: 'A', type: 'single_select',
            prompt: 'You\'re stuck on something and slightly annoyed about it. What should the assistant do?',
            options: [
              { id: 'A9a', label: 'Break it into smaller pieces. Show me the one thing I can do right now.', weights: { analytical: 0.7, practical: 0.8, organized: 0.4 } },
              { id: 'A9b', label: 'Acknowledge the frustration in one line, then pivot to solutions.', weights: { empathetic: 0.7, practical: 0.5, supportive: 0.4 } },
              { id: 'A9c', label: 'Challenge my approach. Maybe I\'m stuck because I\'m thinking about it wrong.', weights: { challenging: 0.8, exploratory: 0.5, proactive: 0.4 } },
              { id: 'A9d', label: 'Suggest a completely different angle. Lateral thinking gets me unstuck.', weights: { exploratory: 0.9, playful: 0.3, big_picture: 0.4 } }
            ]
          },
          {
            id: 'A10', section: 'A', type: 'single_select',
            prompt: 'A long article lands in your lap. How do you consume it?',
            options: [
              { id: 'A10a', label: 'Read carefully, highlight, and summarize the key points.', weights: { detailed: 0.9, organized: 0.5, serious: 0.3 } },
              { id: 'A10b', label: 'Skim for the gist: headings, intro, and any spicy charts.', weights: { big_picture: 0.8, casual: 0.3 } },
              { id: 'A10c', label: 'Jump to the conclusion first. Then backfill only if needed.', weights: { big_picture: 0.7, proactive: 0.3, independent: 0.4 } },
              { id: 'A10d', label: 'Have the assistant give me a punchy brief + actions in bullets.', weights: { organized: 0.5, proactive: 0.5, big_picture: 0.5 } }
            ]
          },
          {
            id: 'A11', section: 'A', type: 'single_select',
            prompt: 'The assistant makes a pun. Your reaction is…',
            options: [
              { id: 'A11a', label: 'MORE. If it\'s not slightly ridiculous, what are we even doing.', weights: { playful: 0.9, casual: 0.6, exploratory: 0.3 } },
              { id: 'A11b', label: 'Occasional jokes are great—just don\'t derail the task.', weights: { playful: 0.6, organized: 0.3, big_picture: 0.3 } },
              { id: 'A11c', label: 'Keep it straightforward. I\'m here to get things done.', weights: { serious: 0.8, formal: 0.3, organized: 0.3, practical: 0.3, analytical: 0.2 } },
              { id: 'A11d', label: 'Only joke when I do. Mirror my energy like a pro.', weights: { collaborative: 0.5, reactive: 0.5, casual: 0.4 } }
            ]
          },
          {
            id: 'A12', section: 'A', type: 'single_select',
            prompt: 'Big decision time — career move, major purchase, life change. You want the assistant to…',
            options: [
              { id: 'A12a', label: 'Run the numbers. Pros, cons, probabilities, expected outcomes.', weights: { analytical: 0.9, practical: 0.6, detailed: 0.5, serious: 0.3 } },
              { id: 'A12b', label: 'Play devil\'s advocate. Challenge my leaning so I\'m sure it holds up.', weights: { challenging: 0.8, analytical: 0.5, independent: 0.3 } },
              { id: 'A12c', label: 'Explore wild options I haven\'t considered. What if there\'s a door 3?', weights: { exploratory: 0.8, playful: 0.4, big_picture: 0.5 } },
              { id: 'A12d', label: 'Help me figure out what I actually want. The answer is usually in the gut feeling.', weights: { empathetic: 0.8, supportive: 0.6, collaborative: 0.4 } }
            ]
          },
          {
            id: 'SECTION_BREAK', section: 'BREAK', type: 'section_break',
            title: 'Almost there! Now let\'s talk about what you need help with.',
            subtitle: 'Tell us what you want help with (and how often). We\'ll tune the assistant accordingly.'
          },
          {
            id: 'B1', section: 'B', type: 'multi_select', maxSelections: 8,
            prompt: 'What do you want help with personally? (Pick any)',
            helperText: 'Pick all that sound useful. You can change this later.',
            options: [
              { id: 'B1_calendar', label: 'Calendar & scheduling', tags: ['personal:calendar'] },
              { id: 'B1_reminders', label: 'Reminders & routines', tags: ['personal:reminders'] },
              { id: 'B1_shopping', label: 'Shopping & price tracking', tags: ['personal:shopping'] },
              { id: 'B1_travel', label: 'Travel planning', tags: ['personal:travel'] },
              { id: 'B1_health', label: 'Health & fitness nudges', tags: ['personal:health'] },
              { id: 'B1_finance', label: 'Budgeting & personal finance', tags: ['personal:finance'] },
              { id: 'B1_meals', label: 'Meals, recipes, groceries', tags: ['personal:meals'] },
              { id: 'B1_learning', label: 'Learning & hobbies', tags: ['personal:learning'] },
              { id: 'B1_home', label: 'Home / life admin (bills, services, chores)', tags: ['personal:home_admin'] },
              { id: 'B1_relationships', label: 'Social planning (birthdays, events)', tags: ['personal:social'] }
            ]
          },
          {
            id: 'B2', section: 'B', type: 'multi_select', maxSelections: 8,
            prompt: 'What do you want help with professionally? (Pick any)',
            helperText: 'Pick all that sound useful. You can change this later.',
            options: [
              { id: 'B2_email', label: 'Email triage & drafting', tags: ['work:email'] },
              { id: 'B2_research', label: 'Research & summaries', tags: ['work:research'] },
              { id: 'B2_writing', label: 'Writing (docs, proposals, briefs)', tags: ['work:writing'] },
              { id: 'B2_coding', label: 'Coding help (debugging, scaffolds, reviews)', tags: ['work:coding'] },
              { id: 'B2_data', label: 'Data analysis (spreadsheets, SQL, charts)', tags: ['work:data_analysis'] },
              { id: 'B2_pm', label: 'Project management (plans, tasks, standups)', tags: ['work:project_management'] },
              { id: 'B2_meetings', label: 'Meeting notes & action items', tags: ['work:meetings'] },
              { id: 'B2_social', label: 'Social media / content ideas', tags: ['work:social_media'] },
              { id: 'B2_sales', label: 'Sales / outreach messaging', tags: ['work:sales'] },
              { id: 'B2_customer', label: 'Customer support drafts / macros', tags: ['work:customer_support'] }
            ]
          },
          {
            id: 'B3', section: 'B', type: 'single_select',
            prompt: 'How often do you expect to interact with your assistant?',
            options: [
              { id: 'B3a', label: 'All day — it\'s basically my second brain.', weights: { proactive: 0.5, collaborative: 0.4, casual: 0.3, organized: 0.3 }, tags: ['usage:high'] },
              { id: 'B3b', label: 'A few times a day — quick questions and a little planning.', weights: { organized: 0.3, proactive: 0.3, big_picture: 0.3 }, tags: ['usage:medium'] },
              { id: 'B3c', label: 'A few times a week — when I need a boost.', weights: { independent: 0.3, reactive: 0.5, big_picture: 0.2 }, tags: ['usage:low'] },
              { id: 'B3d', label: 'Rarely — I want it there, but mostly quiet.', weights: { independent: 0.4, reactive: 0.7, serious: 0.2 }, tags: ['usage:minimal'] }
            ]
          },
          {
            id: 'B4', section: 'B', type: 'short_text',
            prompt: 'What\'s your job / role (or what you spend most of your time doing)?',
            placeholder: 'e.g., Product manager, founder, student, nurse, consultant, stay-at-home parent, etc.',
            field: 'user.role'
          },
          {
            id: 'B5', section: 'B', type: 'short_text',
            prompt: 'What should the assistant call you?',
            placeholder: 'Name or nickname',
            field: 'user.preferred_name'
          },
          {
            id: 'FINAL_SCREEN', section: 'FINAL', type: 'final_screen',
            prompt: 'Anything else your assistant should know?',
            placeholder: 'I\'m a night owl, I hate small talk, I run a landscaping business...'
          }
        ];

        // ======== State ========
        const state = {
          sessionId,
          username: '',
          botName: '',
          currentStep: 2,
          quizIndex: 0,
          answers: {},
          perQuestionContext: {},
          serverStatus: 'queued',
          serverReady: false,
          authComplete: false,
          initRetries: 0,
          webchatUrl: ''
        };

        // ======== Quiz State Persistence ========
        const STORAGE_KEY = `clawdaddy_quiz_${sessionId}`;
        const STORAGE_MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours

        function saveQuizState() {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
              quizIndex: state.quizIndex,
              answers: state.answers,
              perQuestionContext: state.perQuestionContext,
              savedAt: Date.now(),
            }));
          } catch (_) {} // localStorage may be unavailable
        }

        function restoreQuizState() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return false;
            const saved = JSON.parse(raw);
            if (Date.now() - saved.savedAt > STORAGE_MAX_AGE) {
              localStorage.removeItem(STORAGE_KEY);
              return false;
            }
            state.quizIndex = saved.quizIndex || 0;
            state.answers = saved.answers || {};
            state.perQuestionContext = saved.perQuestionContext || {};
            return true;
          } catch (_) {
            return false;
          }
        }

        function clearQuizState() {
          try { localStorage.removeItem(STORAGE_KEY); } catch (_) {}
        }

        // ======== DOM References ========
        const step2Container = document.getElementById('step-2');
        const step3Container = document.getElementById('step-3');
        const step4Container = document.getElementById('step-4');

        const provisionChip = document.getElementById('provision-chip');
        const provisionText = document.getElementById('provision-text');
        const quizProgressFill = document.getElementById('quiz-progress-fill');
        const quizCounter = document.getElementById('quiz-counter');
        const quizQuestionArea = document.getElementById('quiz-question-area');

        const step3Content = document.getElementById('step-3-content');

        // ======== Helpers ========
        function escapeHtml(str) {
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        }

        function showError(el, message) {
          el.textContent = message || '';
        }

        function showStep(stepNum) {
          state.currentStep = stepNum;
          [step2Container, step3Container, step4Container].forEach((el, i) => {
            el.classList.toggle('active', i + 2 === stepNum);
          });
        }

        async function readJson(response) {
          try {
            return await response.json();
          } catch (_error) {
            return {};
          }
        }

        // ======== Provisioning Polling ========
        let pollTimer = null;
        let pollInFlight = false;

        async function pollStatus() {
          if (pollInFlight) return;
          pollInFlight = true;

          try {
            const response = await fetch(`${API_BASE}/api/onboarding/status/${encodeURIComponent(sessionId)}?t=${Date.now()}`, {
              method: 'GET',
              headers: { Accept: 'application/json' }
            });

            const payload = await readJson(response);

            if (!response.ok) {
              if (response.status === 400 || response.status === 404) {
                window.location.replace('./error.html?reason=invalid_session');
                return;
              }
              throw new Error(payload.error || 'Failed to fetch status.');
            }

            state.serverStatus = payload.provisionStatus || 'queued';
            state.webchatUrl = payload.webchatUrl || '';

            if (state.serverStatus === 'ready') {
              state.serverReady = true;
              provisionChip.classList.add('ready');
              provisionText.textContent = 'Server ready';
              clearInterval(pollTimer);
              pollTimer = null;
            }
          } catch (error) {
            // Silently retry
          } finally {
            pollInFlight = false;
          }
        }

        function startPolling() {
          void pollStatus();
          if (pollTimer) clearInterval(pollTimer);
          pollTimer = setInterval(pollStatus, 3000);
        }

        // ======== Quiz Engine (Step 2) ========
        function updateProgress() {
          const totalScreens = QUIZ_QUESTIONS.length;
          const percent = ((state.quizIndex + 1) / totalScreens) * 100;
          quizProgressFill.style.width = `${percent}%`;

          // Count actual questions (exclude section break and final screen)
          const questionCount = QUIZ_QUESTIONS.filter(q => q.type !== 'section_break' && q.type !== 'final_screen').length;
          const currentQuestionNum = QUIZ_QUESTIONS.slice(0, state.quizIndex + 1).filter(q => q.type !== 'section_break' && q.type !== 'final_screen').length;
          quizCounter.textContent = `Question ${currentQuestionNum} of ${questionCount}`;
        }

        function measureSlideHeight() {
          requestAnimationFrame(() => {
            const slide = quizQuestionArea.querySelector('.quiz-slide');
            if (slide) {
              const height = slide.offsetHeight;
              quizQuestionArea.style.minHeight = Math.max(420, height) + 'px';
            }
          });
        }

        function renderQuestion() {
          const q = QUIZ_QUESTIONS[state.quizIndex];
          updateProgress();

          if (q.type === 'section_break') {
            quizQuestionArea.innerHTML = `
              <div class="quiz-slide section-break">
                <h3>${q.title}</h3>
                <p>${q.subtitle}</p>
                <div class="quiz-nav">
                  <button class="quiz-back">← Back</button>
                  <button class="quiz-continue">Continue</button>
                </div>
              </div>
            `;
            attachSectionBreakListeners();
            measureSlideHeight();
            return;
          }

          if (q.type === 'final_screen') {
            quizQuestionArea.innerHTML = `
              <div class="quiz-slide">
                <div class="quiz-prompt">${q.prompt}</div>
                <textarea class="final-textarea" id="final-textarea" placeholder="${q.placeholder}"></textarea>
                <div class="quiz-nav">
                  <button class="quiz-back">← Back</button>
                  <button class="quiz-continue">Finish Quiz</button>
                </div>
              </div>
            `;
            attachFinalScreenListeners();
            measureSlideHeight();
            return;
          }

          if (q.type === 'single_select') {
            renderSingleSelect(q);
          } else if (q.type === 'multi_select') {
            renderMultiSelect(q);
          } else if (q.type === 'short_text') {
            renderShortText(q);
          }
        }

        function renderSingleSelect(q) {
          const optionsHtml = q.options.map(opt => {
            const selected = state.answers[q.id] === opt.id ? 'selected' : '';
            return `<button class="quiz-option ${selected}" data-option-id="${opt.id}">${opt.label}</button>`;
          }).join('');

          const contextExpanded = state.perQuestionContext[q.id] !== undefined;
          const contextValue = state.perQuestionContext[q.id] || '';

          quizQuestionArea.innerHTML = `
            <div class="quiz-slide">
              <div class="quiz-prompt">${q.prompt}</div>
              <div class="quiz-options">${optionsHtml}</div>
              <button class="add-context-toggle">+ Add context</button>
              <div class="context-input ${contextExpanded ? '' : 'hidden'}">
                <textarea placeholder="Add any context..." id="context-textarea">${escapeHtml(contextValue)}</textarea>
              </div>
              <div class="quiz-nav">
                ${state.quizIndex > 0 ? '<button class="quiz-back">← Back</button>' : '<div></div>'}
                <div></div>
              </div>
            </div>
          `;

          attachSingleSelectListeners(q);
          measureSlideHeight();
        }

        function renderMultiSelect(q) {
          const selected = Array.isArray(state.answers[q.id]) ? state.answers[q.id] : [];
          const optionsHtml = q.options.map(opt => {
            const isSelected = selected.includes(opt.id) ? 'selected' : '';
            return `<button class="quiz-option multi ${isSelected}" data-option-id="${opt.id}">${opt.label}</button>`;
          }).join('');

          const contextExpanded = state.perQuestionContext[q.id] !== undefined;
          const contextValue = state.perQuestionContext[q.id] || '';

          quizQuestionArea.innerHTML = `
            <div class="quiz-slide">
              <div class="quiz-prompt">${q.prompt}</div>
              ${q.helperText ? `<div class="quiz-helper">${q.helperText}</div>` : ''}
              <div class="quiz-options">${optionsHtml}</div>
              <button class="add-context-toggle">+ Add context</button>
              <div class="context-input ${contextExpanded ? '' : 'hidden'}">
                <textarea placeholder="Add any context..." id="context-textarea">${escapeHtml(contextValue)}</textarea>
              </div>
              <div class="quiz-nav">
                ${state.quizIndex > 0 ? '<button class="quiz-back">← Back</button>' : '<div></div>'}
                <button class="quiz-continue">Continue</button>
              </div>
            </div>
          `;

          attachMultiSelectListeners(q);
          measureSlideHeight();
        }

        function renderShortText(q) {
          const value = state.answers[q.id] || '';

          quizQuestionArea.innerHTML = `
            <div class="quiz-slide">
              <div class="quiz-prompt">${q.prompt}</div>
              <input class="input" type="text" id="short-text-input" placeholder="${q.placeholder}" value="${escapeHtml(value)}" />
              <div class="skip-text">You can skip this — your assistant won't judge you.</div>
              <div class="quiz-nav">
                ${state.quizIndex > 0 ? '<button class="quiz-back">← Back</button>' : '<div></div>'}
                <button class="quiz-continue">Continue</button>
              </div>
            </div>
          `;

          attachShortTextListeners(q);
          measureSlideHeight();
        }

        function attachSingleSelectListeners(q) {
          const options = quizQuestionArea.querySelectorAll('.quiz-option');
          options.forEach(optEl => {
            optEl.addEventListener('click', () => {
              const optionId = optEl.dataset.optionId;
              state.answers[q.id] = optionId;
              saveQuizState();

              options.forEach(o => o.classList.remove('selected'));
              optEl.classList.add('selected');

              setTimeout(() => {
                nextQuestion();
              }, 400);
            });
          });

          attachContextToggle(q);
          attachBackButton();
        }

        function attachMultiSelectListeners(q) {
          const options = quizQuestionArea.querySelectorAll('.quiz-option.multi');
          options.forEach(optEl => {
            optEl.addEventListener('click', () => {
              const optionId = optEl.dataset.optionId;
              let selected = Array.isArray(state.answers[q.id]) ? state.answers[q.id] : [];

              if (selected.includes(optionId)) {
                selected = selected.filter(id => id !== optionId);
                optEl.classList.remove('selected');
              } else {
                if (q.maxSelections && selected.length >= q.maxSelections) {
                  return;
                }
                selected.push(optionId);
                optEl.classList.add('selected');
              }

              state.answers[q.id] = selected;
              saveQuizState();
            });
          });

          attachContextToggle(q);
          attachBackButton();
          attachContinueButton();
        }

        function attachShortTextListeners(q) {
          const input = document.getElementById('short-text-input');
          input.addEventListener('input', (e) => {
            state.answers[q.id] = e.target.value.trim();
            saveQuizState();
          });

          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              nextQuestion();
            }
          });

          attachBackButton();
          attachContinueButton();
        }

        function attachSectionBreakListeners() {
          attachBackButton();
          attachContinueButton();
        }

        function attachFinalScreenListeners() {
          const textarea = document.getElementById('final-textarea');
          textarea.addEventListener('input', (e) => {
            state.answers['FINAL_SCREEN'] = e.target.value.trim();
            saveQuizState();
          });

          attachBackButton();

          const continueBtn = quizQuestionArea.querySelector('.quiz-continue');
          continueBtn.addEventListener('click', () => {
            submitQuiz();
          });
        }

        function attachContextToggle(q) {
          const toggle = quizQuestionArea.querySelector('.add-context-toggle');
          const contextInput = quizQuestionArea.querySelector('.context-input');
          const textarea = document.getElementById('context-textarea');

          if (!toggle || !contextInput || !textarea) return;

          toggle.addEventListener('click', () => {
            const isHidden = contextInput.classList.contains('hidden');
            if (isHidden) {
              contextInput.classList.remove('hidden');
              textarea.focus();
            } else {
              contextInput.classList.add('hidden');
            }
          });

          textarea.addEventListener('input', (e) => {
            state.perQuestionContext[q.id] = e.target.value.trim();
            saveQuizState();
          });
        }

        function attachBackButton() {
          const backBtn = quizQuestionArea.querySelector('.quiz-back');
          if (backBtn) {
            backBtn.addEventListener('click', () => {
              prevQuestion();
            });
          }
        }

        function attachContinueButton() {
          const continueBtn = quizQuestionArea.querySelector('.quiz-continue');
          if (continueBtn) {
            continueBtn.addEventListener('click', () => {
              nextQuestion();
            });
          }
        }

        function nextQuestion() {
          if (state.quizIndex < QUIZ_QUESTIONS.length - 1) {
            const currentSlide = quizQuestionArea.querySelector('.quiz-slide');
            if (currentSlide) {
              currentSlide.classList.add('slide-out-left');
            }

            setTimeout(() => {
              state.quizIndex++;
              saveQuizState();
              renderQuestion();
            }, 300);
          }
        }

        function prevQuestion() {
          if (state.quizIndex > 0) {
            const currentSlide = quizQuestionArea.querySelector('.quiz-slide');
            if (currentSlide) {
              currentSlide.classList.add('slide-out-right');
            }

            setTimeout(() => {
              state.quizIndex--;
              saveQuizState();
              renderQuestion();
            }, 300);
          }
        }

        async function submitQuiz() {
          const scores = calculateScores(state.answers, state.perQuestionContext);

          const anythingElse = state.answers['FINAL_SCREEN'] || '';
          if (anythingElse) {
            scores.freeText.anything_else = anythingElse;
          }

          // Show progress UI
          const stages = ['analyzing', 'generating', 'agents', 'complete'];
          const stageLabels = { analyzing: 'Analyze', generating: 'Generate', agents: 'Agents', complete: 'Done' };

          quizQuestionArea.innerHTML = `
            <div class="profile-progress">
              <p class="profile-message">Submitting quiz...</p>
              <div class="profile-stages">
                ${stages.map(s => `
                  <div class="profile-stage" data-stage="${s}">
                    <div class="profile-stage-dot"></div>
                    <div class="profile-stage-label">${stageLabels[s]}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;

          function updateStage(currentStage) {
            stages.forEach(s => {
              const stageEl = quizQuestionArea.querySelector(`[data-stage="${s}"]`);
              if (!stageEl) return;
              const dot = stageEl.querySelector('.profile-stage-dot');
              const label = stageEl.querySelector('.profile-stage-label');
              const idx = stages.indexOf(s);
              const currentIdx = stages.indexOf(currentStage);
              dot.className = 'profile-stage-dot' + (idx < currentIdx ? ' done' : idx === currentIdx ? ' active' : '');
              label.className = 'profile-stage-label' + (idx < currentIdx ? ' done' : idx === currentIdx ? ' active' : '');
            });
          }

          try {
            // Submit quiz results
            const quizRes = await fetch(`${API_BASE}/api/onboarding/quiz/${encodeURIComponent(sessionId)}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
              body: JSON.stringify({
                answers: state.answers,
                perQuestionContext: state.perQuestionContext,
                traits: scores.traits,
                dimensionScores: scores.dimensionScores,
                tags: scores.tags,
                freeText: scores.freeText
              })
            });
            if (!quizRes.ok) throw new Error('Failed to save quiz results.');

            clearQuizState();

            // Try SSE for profile generation
            let sseSucceeded = false;
            try {
              await new Promise((resolve, reject) => {
                const url = `${API_BASE}/api/onboarding/generate-profile/${encodeURIComponent(sessionId)}/stream`;
                const es = new EventSource(url);
                let gotFirstEvent = false;

                const timeout = setTimeout(() => {
                  if (!gotFirstEvent) {
                    es.close();
                    reject(new Error('SSE timeout'));
                  }
                }, 10000);

                es.onmessage = (event) => {
                  gotFirstEvent = true;
                  clearTimeout(timeout);
                  try {
                    const data = JSON.parse(event.data);
                    if (data.stage === 'error') {
                      es.close();
                      reject(new Error(data.message));
                      return;
                    }
                    updateStage(data.stage);
                    const msgEl = quizQuestionArea.querySelector('.profile-message');
                    if (msgEl) msgEl.textContent = data.message;
                    if (data.stage === 'complete') {
                      es.close();
                      sseSucceeded = true;
                      resolve();
                    }
                  } catch (_) {}
                };

                es.onerror = () => {
                  if (!gotFirstEvent) {
                    clearTimeout(timeout);
                    es.close();
                    reject(new Error('SSE connection failed'));
                  }
                  // If we already got events, EventSource will auto-reconnect
                };
              });
            } catch (sseErr) {
              // Fallback to synchronous POST
              console.warn('SSE failed, falling back to sync:', sseErr.message);
              const msgEl = quizQuestionArea.querySelector('.profile-message');
              if (msgEl) msgEl.textContent = 'Building your profile (this takes about 2 minutes)...';
              updateStage('generating');
              const profileRes = await fetch(`${API_BASE}/api/onboarding/generate-profile/${encodeURIComponent(sessionId)}`, {
                method: 'POST',
                headers: { Accept: 'application/json' }
              });
              if (!profileRes.ok) throw new Error('Failed to generate profile.');
              sseSucceeded = true;
            }

            if (sseSucceeded) {
              showStep(3);
              renderStep3();
            }
          } catch (error) {
            quizQuestionArea.innerHTML = `
              <div style="text-align:center;padding:2rem 0;">
                <p style="color:#fca5a5;margin-bottom:1rem;">${escapeHtml(error.message || 'Error submitting quiz.')}</p>
                <button class="button" onclick="location.reload()">Try Again</button>
              </div>
            `;
          }
        }

        function calculateScores(answers, perQuestionContext) {
          const traits = {
            organized: 0, spontaneous: 0, formal: 0, casual: 0,
            proactive: 0, reactive: 0, detailed: 0, big_picture: 0,
            serious: 0, playful: 0, independent: 0, collaborative: 0,
            supportive: 0, challenging: 0, practical: 0, exploratory: 0,
            analytical: 0, empathetic: 0
          };
          const tags = [];
          const freeText = {};

          for (const q of QUIZ_QUESTIONS) {
            const answer = answers[q.id];
            if (!answer) continue;

            if (q.type === 'single_select') {
              const opt = q.options.find(o => o.id === answer);
              if (opt?.weights) {
                for (const [trait, w] of Object.entries(opt.weights)) {
                  traits[trait] += Math.min(Math.max(w, 0), 1);
                }
              }
              if (opt?.tags) tags.push(...opt.tags);
            } else if (q.type === 'multi_select') {
              const selected = Array.isArray(answer) ? answer : [];
              for (const selId of selected) {
                const opt = q.options.find(o => o.id === selId);
                if (opt?.tags) tags.push(...opt.tags);
                if (opt?.weights) {
                  for (const [trait, w] of Object.entries(opt.weights)) {
                    traits[trait] += Math.min(Math.max(w, 0), 1);
                  }
                }
              }
            } else if (q.type === 'short_text' && answer) {
              freeText[q.field] = answer;
            }
          }

          const epsilon = 1e-9;
          const dimensions = {
            organized_vs_spontaneous: ['organized', 'spontaneous'],
            formal_vs_casual: ['formal', 'casual'],
            proactive_vs_reactive: ['proactive', 'reactive'],
            detailed_vs_big_picture: ['detailed', 'big_picture'],
            serious_vs_playful: ['serious', 'playful'],
            independent_vs_collaborative: ['independent', 'collaborative'],
            supportive_vs_challenging: ['supportive', 'challenging'],
            practical_vs_exploratory: ['practical', 'exploratory'],
            analytical_vs_empathetic: ['analytical', 'empathetic']
          };

          const dimensionScores = {};
          for (const [dim, [left, right]] of Object.entries(dimensions)) {
            const L = traits[left], R = traits[right];
            dimensionScores[dim] = (L + R === 0) ? 0.5 : L / (L + R + epsilon);
          }

          return { traits, dimensionScores, tags, freeText };
        }

        // ======== Step 3: Connect Your AI ========
        const PROVIDER_COLORS = {
          anthropic: '#D4A373', openai: '#10A37F', openrouter: '#6366F1',
          google: '#4285F4', xai: '#a1a1aa', groq: '#F55036',
        };
        const connectedProviders = new Set();
        let providerList = [];

        async function renderStep3() {
          if (!state.serverReady) {
            step3Content.innerHTML = `
              <div style="text-align:center;padding:2rem 0;">
                <div class="provision-chip">
                  <span class="pulse-dot"></span>
                  <span>Waiting for your server to finish setting up...</span>
                </div>
                <p style="color:#a1a1aa;margin-top:0.5rem;">This usually takes 2-3 minutes.</p>
              </div>
            `;
            const checkInterval = setInterval(() => {
              if (state.serverReady) { clearInterval(checkInterval); renderStep3(); }
            }, 1000);
            return;
          }

          // Fetch providers
          if (providerList.length === 0) {
            try {
              const res = await fetch(`${API_BASE}/api/providers`);
              const data = await res.json();
              providerList = data.providers || [];
            } catch (_) {
              providerList = [
                { id: 'anthropic', name: 'Anthropic', supportsOAuth: true, supportsApiKey: true },
                { id: 'openai', name: 'OpenAI', supportsOAuth: false, supportsApiKey: true },
              ];
            }
          }

          step3Content.innerHTML = `
            <p style="color:#d4d4d8;line-height:1.6;">Connect at least one AI provider so your assistant can think. You can add more later.</p>
            <div class="provider-grid" id="provider-grid"></div>
            <div id="provider-detail-area"></div>
            <button class="button" id="auth-continue-btn" disabled style="margin-top:1rem;width:100%;">Continue</button>
          `;

          renderProviderGrid();

          document.getElementById('auth-continue-btn').addEventListener('click', () => {
            showStep(4);
            renderSetupComplete();
          });
        }

        function renderProviderGrid() {
          const grid = document.getElementById('provider-grid');
          grid.innerHTML = providerList.map(p => {
            const initial = p.name.charAt(0);
            const color = PROVIDER_COLORS[p.id] || '#71717a';
            const isConnected = connectedProviders.has(p.id);
            return `
              <div class="provider-card ${isConnected ? 'connected' : ''}" data-provider="${p.id}">
                <div class="provider-icon" style="background:${color}">${initial}</div>
                <div class="provider-name">${escapeHtml(p.name)}</div>
                <span class="provider-badge ${isConnected ? 'connected' : 'disconnected'}">${isConnected ? 'Connected' : 'Not set'}</span>
              </div>
            `;
          }).join('');

          grid.querySelectorAll('.provider-card').forEach(card => {
            card.addEventListener('click', () => {
              const providerId = card.dataset.provider;
              const provider = providerList.find(p => p.id === providerId);
              if (provider) showProviderDetail(provider);
              grid.querySelectorAll('.provider-card').forEach(c => c.classList.remove('active'));
              card.classList.add('active');
            });
          });

          // Update continue button
          const btn = document.getElementById('auth-continue-btn');
          if (btn) btn.disabled = connectedProviders.size === 0;
        }

        function showProviderDetail(provider) {
          const area = document.getElementById('provider-detail-area');
          const isConnected = connectedProviders.has(provider.id);

          let html = `<div class="provider-detail">`;
          html += `<h3 style="font-size:1rem;font-weight:700;margin:0 0 0.75rem;">${escapeHtml(provider.name)}</h3>`;

          if (isConnected) {
            html += `<p style="color:#4ade80;font-size:0.9rem;">Connected</p>`;
            html += `</div>`;
            area.innerHTML = html;
            return;
          }

          if (provider.supportsOAuth) {
            html += `
              <button class="button" id="oauth-start-btn" style="width:100%;">Sign in with ${escapeHtml(provider.name)}</button>
              <div id="oauth-paste-area" class="hidden" style="margin-top:0.75rem;">
                <p style="color:#d4d4d8;font-size:0.88rem;margin-bottom:0.5rem;">
                  After authorizing, paste the <strong>CODE#STATE</strong> below:
                </p>
                <input class="input" id="oauth-code-input" type="text" placeholder="Paste CODE#STATE here" autocomplete="off" />
                <button class="button" id="oauth-submit-btn" disabled style="margin-top:0.5rem;width:100%;">Verify</button>
              </div>
            `;
          }

          if (provider.supportsOAuth && provider.supportsApiKey) {
            html += `<div class="provider-divider">or</div>`;
          }

          if (provider.supportsApiKey) {
            html += `
              <div>
                <input class="input" id="api-key-input" type="password" placeholder="Paste your API key" autocomplete="off" />
                <button class="button" id="api-key-submit-btn" style="margin-top:0.5rem;width:100%;">Save Key</button>
              </div>
            `;
          }

          html += `<p id="provider-feedback" style="min-height:1.4rem;font-size:0.88rem;margin-top:0.5rem;"></p>`;
          html += `</div>`;
          area.innerHTML = html;

          // OAuth flow
          if (provider.supportsOAuth) {
            document.getElementById('oauth-start-btn').addEventListener('click', async () => {
              const btn = document.getElementById('oauth-start-btn');
              btn.disabled = true;
              btn.textContent = 'Opening...';
              try {
                const res = await fetch(`${API_BASE}/api/onboarding/auth/start`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ stripeSessionId: sessionId, provider: provider.id })
                });
                const data = await res.json();
                if (!data.ok) throw new Error(data.error);
                window.open(data.url, '_blank');
                document.getElementById('oauth-paste-area').classList.remove('hidden');
                btn.textContent = 'Link opened \u2014 paste code below';
              } catch (err) {
                showFeedback(err.message, true);
                btn.disabled = false;
                btn.textContent = `Sign in with ${provider.name}`;
              }
            });

            const codeInput = document.getElementById('oauth-code-input');
            const submitBtn = document.getElementById('oauth-submit-btn');
            if (codeInput && submitBtn) {
              codeInput.addEventListener('input', () => { submitBtn.disabled = !codeInput.value.trim(); });
              submitBtn.addEventListener('click', async () => {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Verifying...';
                try {
                  const res = await fetch(`${API_BASE}/api/onboarding/auth/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stripeSessionId: sessionId, codeState: codeInput.value.trim(), provider: provider.id })
                  });
                  const data = await res.json();
                  if (!data.ok) throw new Error(data.error);
                  markProviderConnected(provider.id);
                } catch (err) {
                  showFeedback(err.message, true);
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'Verify';
                }
              });
            }
          }

          // API key flow
          if (provider.supportsApiKey) {
            const keyInput = document.getElementById('api-key-input');
            const keyBtn = document.getElementById('api-key-submit-btn');
            keyBtn.addEventListener('click', async () => {
              const key = keyInput.value.trim();
              if (!key) return;
              keyBtn.disabled = true;
              keyBtn.textContent = 'Verifying...';
              showFeedback('');

              // Verify key first
              try {
                const verifyRes = await fetch(`${API_BASE}/api/onboarding/auth/verify`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ provider: provider.id, apiKey: key })
                });
                const verifyData = await verifyRes.json();
                if (verifyData.ok && !verifyData.valid) {
                  showFeedback(verifyData.error || 'Invalid key \u2014 check and try again.', true);
                  keyBtn.disabled = false;
                  keyBtn.textContent = 'Save Key';
                  return;
                }
              } catch (_) {
                // Verification endpoint failed — proceed anyway
              }

              // Save key
              try {
                const res = await fetch(`${API_BASE}/api/onboarding/auth/api-key`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ stripeSessionId: sessionId, provider: provider.id, apiKey: key })
                });
                const data = await res.json();
                if (!data.ok) throw new Error(data.error);
                markProviderConnected(provider.id);
              } catch (err) {
                showFeedback(err.message, true);
                keyBtn.disabled = false;
                keyBtn.textContent = 'Save Key';
              }
            });
          }
        }

        function showFeedback(message, isError) {
          const el = document.getElementById('provider-feedback');
          if (el) {
            el.textContent = message;
            el.style.color = isError ? '#fca5a5' : '#4ade80';
          }
        }

        function markProviderConnected(providerId) {
          connectedProviders.add(providerId);
          renderProviderGrid();
          showProviderDetail(providerList.find(p => p.id === providerId));
        }

        // ======== Step 4: Setup Complete (post-quiz) ========
        function renderSetupComplete() {
          const url = `https://${state.username}.clawdaddy.sh`;
          state.webchatUrl = url;

          const step4 = document.getElementById('step-4');
          step4.querySelector('.success-state').innerHTML = `
            <img src="../assets/lobster-thumbsup.png" alt="ClawDaddy thumbs up" class="pop-in" style="height:220px;margin:0 auto 1rem;display:block" />
            <h2 class="success-title">You're all set!</h2>
            <p style="color: var(--text-muted); font-size: 1.05rem; line-height: 1.6; margin: 1rem 0;">
              Your assistant is live at:
            </p>
            <div class="success-url">${escapeHtml(url)}</div>
            <button class="copy-btn" id="copy-url-btn-setup">
              <span>\u{1F4CB}</span> <span>Copy URL</span>
            </button>
            <p class="bookmark-text">Bookmark this \u2014 it's your assistant's home</p>
            <p class="redirect-text" id="redirect-countdown-text"></p>
            <button class="button" id="open-now-btn-setup" style="margin-top: 0.5rem;">Open now</button>
          `;

          const copyBtn = document.getElementById('copy-url-btn-setup');
          if (copyBtn) {
            copyBtn.addEventListener('click', () => {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                  copyBtn.innerHTML = '<span>\u2713</span> <span>Copied!</span>';
                  copyBtn.classList.add('copied');
                  setTimeout(() => {
                    copyBtn.innerHTML = '<span>\u{1F4CB}</span> <span>Copy URL</span>';
                    copyBtn.classList.remove('copied');
                  }, 2000);
                }).catch(() => {});
              }
            });
          }

          const openBtn = document.getElementById('open-now-btn-setup');
          if (openBtn) {
            openBtn.addEventListener('click', () => {
              window.location.href = url;
            });
          }

          // Countdown redirect
          const countdownEl = document.getElementById('redirect-countdown-text');
          let remaining = 8;
          const tick = () => {
            if (remaining > 0) {
              countdownEl.textContent = `Redirecting in ${remaining}...`;
              remaining--;
              setTimeout(tick, 1000);
            } else {
              window.location.href = url;
            }
          };
          tick();
        }
      })();
    </script>
  </body>
</html>
