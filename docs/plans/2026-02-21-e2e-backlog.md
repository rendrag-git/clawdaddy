# E2E Testing Backlog — 2026-02-21

## BLOCKER: Auth code submission (stdin pipe to PTY)

**Status:** `claude setup-token` generates OAuth URL correctly, customer authorizes, gets CODE#STATE. But the code never reaches the process via `proc.stdin.write()`.

**Debug evidence:** Raw buffer after 45s timeout still shows `Paste code here if prompted >` — code was never received by the process. Both `\n` and `\r` fail.

**Root cause hypothesis:** Node `spawn` with `stdio: ['pipe', 'pipe', 'pipe']` + SSH `-tt` PTY — stdin may not relay through the double-PTY layer (SSH PTY → Docker exec -it PTY → claude setup-token Ink TUI).

**Next steps:**
1. Test stdin delivery: write something to stdin immediately after spawn (before URL capture) to confirm it works at all
2. Try `node-pty` instead of `spawn` for proper PTY emulation
3. Alternative approach: Don't pipe code into running process. Instead:
   - Step 1: `claude setup-token` → get OAuth URL (works) → kill process
   - Customer authorizes → gets CODE#STATE → pastes in frontend
   - Step 2: New SSH call with `claude setup-token` again, but pipe code immediately
   - OR: Use the Anthropic OAuth API directly from server-side (no SSH needed)

## Bugs Fixed Today (deployed)

- [x] customers.json removed from provision.sh (SQLite authoritative)
- [x] Webhook secrets from .secrets/ files (not systemd env)
- [x] Checkout success_url: api.clawdaddy.sh → clawdaddy.sh/onboarding/
- [x] Pricing CTAs link to #signup with plan pre-select
- [x] Provisioner passes --username to provision.sh
- [x] Tier mapping: starter/pro/power → byok
- [x] Docker image includes claude + codex + openclaw + build tools
- [x] SSH auth commands exec into Docker container
- [x] OAuth URL ANSI stripping for PTY word-wrap
- [x] Token parsing uses buffer-based ANSI stripping
- [x] writeAuthProfile uses openclaw paste-token CLI

## UX Improvements Needed

- [ ] Profile gen: no progress indicator ("Generating your profile..." for 2min with no feedback)
- [ ] Provisioning status not shown to customer (stages emitted server-side, not surfaced)
- [ ] "Instance not provisioned yet" on auth page — should auto-poll and transition
- [ ] Quiz state not persisted — customer restarts from scratch on page refresh or return
- [ ] Server restart kills in-flight auth sessions (in-memory Map)
- [ ] Price mismatch: signup section $10/$35/$75 vs pricing cards $19/$35/$79

## Backend Improvements

- [ ] Switch profile gen from OpenRouter to Anthropic API direct
- [ ] Consider Sonnet over Opus for profile gen (~30s vs ~2min)
- [ ] Tier-to-instance-size mapping (starter/pro/power → different Lightsail bundles)
- [ ] Docker image update path for existing instances (can't just pull without env vars)
- [ ] SCP file deployment: Permission denied on `/home/ubuntu/clawd/SOUL.md` (ownership issue)
- [ ] `api/lib/provisioner.js` is dead code — delete or wire up
- [ ] `generate_user_data()` / `add_customer_record()` positional args → named args
- [ ] Clean up old test Lightsail instances + customer records

## Infrastructure

- [ ] `static_ip`/`static_ip_name` fields in schema → rename to `public_ip`
- [ ] DNS update oneshot fails on first boot (timing)
- [ ] Old `openclaw-webhook.service` in repo references `/opt/openclaw-webhook` — delete
- [ ] Zombie process resilience: onboarding service crashed for 18hrs from port squatter
